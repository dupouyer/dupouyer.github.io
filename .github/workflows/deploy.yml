name: Build and Deploy Astro

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ° master åˆ†æ”¯æ—¶è‡ªåŠ¨æž„å»º
on:
  push:
    branches:
      - master
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆåŒ…æ‹¬å­æ¨¡å—ï¼‰
    - name: Checkout ðŸ›Žï¸
      uses: actions/checkout@v4
      with:
        submodules: recursive  # é€’å½’å…‹éš†å­æ¨¡å—ï¼ˆPublishNoteï¼‰
        fetch-depth: 0         # èŽ·å–å®Œæ•´çš„ git åŽ†å²

    # 2. å®‰è£… pnpm
    - name: Setup pnpm ðŸ”§
      uses: pnpm/action-setup@v4
      with:
        version: 9

    # 3. è®¾ç½® Node.js çŽ¯å¢ƒ
    - name: Setup Node.js ðŸ”§
      uses: actions/setup-node@v4
      with:
        node-version: '18'     # ä½¿ç”¨ Node.js 18 LTS
        cache: 'pnpm'          # ç¼“å­˜ pnpm ä¾èµ–ä»¥åŠ å¿«æž„å»ºé€Ÿåº¦
        cache-dependency-path: 'Site/Astro/pnpm-lock.yaml'

    # 4. å®‰è£…ä¾èµ–
    - name: Install Dependencies ðŸ“¦
      run: |
        cd Site/Astro && pnpm install --frozen-lockfile

    # 5. åˆå§‹åŒ–å’ŒéªŒè¯ PublishNote å­æ¨¡å—
    - name: Setup Submodules ðŸ“š
      run: |
        echo "Checking submodule status..."
        git submodule status
        echo "Initializing submodules..."
        git submodule update --init --recursive
        echo "Verifying PublishNote..."
        ls -la PublishNote/
        echo "Found $(find PublishNote -name "*.md" | wc -l) markdown files"

    # 6. åŒæ­¥ PublishNote æ–‡ç« åˆ° Astro content ç›®å½•
    - name: Sync PublishNote Articles ðŸ“
      run: |
        # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
        mkdir -p Site/Astro/src/content/blog
        # ä»Ž PublishNote å­æ¨¡å—å¤åˆ¶æ‰€æœ‰ .md æ–‡ä»¶åˆ° content/blog
        find PublishNote -name "*.md" -type f -exec cp {} Site/Astro/src/content/blog/ \;
        echo "âœ… Synced $(find PublishNote -name "*.md" | wc -l) articles from PublishNote"
        echo "ðŸ“„ Total posts in Site/Astro/src/content/blog: $(ls -1 Site/Astro/src/content/blog/*.md 2>/dev/null | wc -l)"

    # 7. ä¿®å¤å›¾ç‰‡è·¯å¾„å¼•ç”¨
    - name: Fix Image References ðŸ”§
      run: |
        # ä¿®å¤ markdown æ–‡ä»¶ä¸­çš„ç›¸å¯¹å›¾ç‰‡è·¯å¾„ï¼Œæ”¹ä¸ºç»å¯¹è·¯å¾„
        find Site/Astro/src/content/blog -name "*.md" -type f -exec sed -i -E 's|\]\(\.\/[^)]+\/|\](/images/|g' {} \;
        echo "âœ… Fixed image references in markdown files"

    # 8. æž„å»ºé™æ€ç«™ç‚¹
    - name: Build Astro Site ðŸ—ï¸
      run: |
        cd Site/Astro && pnpm run build

    # 9. éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
    - name: Deploy to gh-pages Branch ðŸš€
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./Site/Astro/dist
        publish_branch: gh-pages
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy Astro site - ${{ github.event.head_commit.message }}'

    # 10. æž„å»ºæ‘˜è¦ï¼ˆå¯é€‰ï¼‰
    - name: Build Summary ðŸ“Š
      if: success()
      run: |
        echo "### ðŸš€ Astro Site Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ Site will be available at: https://dupouyer.github.io" >> $GITHUB_STEP_SUMMARY

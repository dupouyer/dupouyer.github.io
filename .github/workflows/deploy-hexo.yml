name: Build and Deploy Hexo

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ° master åˆ†æ”¯æ—¶è‡ªåŠ¨æž„å»º
on:
  push:
    branches:
      - master
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆåŒ…æ‹¬å­æ¨¡å—ï¼‰
    - name: Checkout ðŸ›Žï¸
      uses: actions/checkout@v4
      with:
        submodules: recursive  # é€’å½’å…‹éš†å­æ¨¡å—ï¼ˆPublishNoteï¼‰
        fetch-depth: 0         # èŽ·å–å®Œæ•´çš„ git åŽ†å²

    # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
    - name: Setup Node.js ðŸ”§
      uses: actions/setup-node@v4
      with:
        node-version: '18'     # ä½¿ç”¨ Node.js 18 LTS ç‰ˆæœ¬
        cache: 'npm'           # ç¼“å­˜ npm ä¾èµ–ä»¥åŠ å¿«æž„å»ºé€Ÿåº¦

    # 3. å®‰è£… Pandocï¼ˆç”¨äºŽæŸäº› Hexo æ’ä»¶çš„æ–‡æ¡£è½¬æ¢ï¼‰
    - name: Install Pandoc ðŸ“„
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc

    # 4. å®‰è£… Hexo CLI å’Œé¡¹ç›®ä¾èµ–
    - name: Install Dependencies ðŸ“¦
      run: |
        npm install -g hexo-cli
        npm install

    # 5. æ¸…ç†å¹¶ç”Ÿæˆé™æ€ç«™ç‚¹
    - name: Build Hexo Site ðŸ—ï¸
      run: |
        hexo clean
        hexo generate

    # 6. éƒ¨ç½²åˆ° GitHub Pages
    - name: Deploy to GitHub Pages ðŸš€
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH: gh-pages           # éƒ¨ç½²åˆ°çš„ç›®æ ‡åˆ†æ”¯
        FOLDER: public              # è¦éƒ¨ç½²çš„æ–‡ä»¶å¤¹ï¼ˆHexo ç”Ÿæˆçš„é™æ€æ–‡ä»¶ï¼‰
        CLEAN: true                 # è‡ªåŠ¨æ¸…ç†ç›®æ ‡åˆ†æ”¯ä¸Šä¸å­˜åœ¨çš„æ–‡ä»¶
        COMMIT_MESSAGE: 'Deploy Hexo site - ${{ github.event.head_commit.message }}'
        COMMIT_NAME: 'GitHub Actions'
        COMMIT_EMAIL: 'actions@github.com'

    # 7. æž„å»ºæ‘˜è¦ï¼ˆå¯é€‰ï¼‰
    - name: Build Summary ðŸ“Š
      if: success()
      run: |
        echo "### ðŸš€ Hexo Site Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ Site will be available at: https://dupouyer.github.io" >> $GITHUB_STEP_SUMMARY

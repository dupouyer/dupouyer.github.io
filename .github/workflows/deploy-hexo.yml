name: Build and Deploy Hexo

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ° master åˆ†æ”¯æ—¶è‡ªåŠ¨æž„å»º
on:
  push:
    branches:
      - master
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆåŒ…æ‹¬å­æ¨¡å—ï¼‰
    - name: Checkout ðŸ›Žï¸
      uses: actions/checkout@v4
      with:
        submodules: recursive  # é€’å½’å…‹éš†å­æ¨¡å—ï¼ˆPublishNoteï¼‰
        fetch-depth: 0         # èŽ·å–å®Œæ•´çš„ git åŽ†å²

    # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
    - name: Setup Node.js ðŸ”§
      uses: actions/setup-node@v4
      with:
        node-version: '18'     # ä½¿ç”¨ Node.js 18 LTS
        cache: 'npm'           # ç¼“å­˜ npm ä¾èµ–ä»¥åŠ å¿«æž„å»ºé€Ÿåº¦

    # 3. å®‰è£… Pandocï¼ˆç”¨äºŽæŸäº› Hexo æ’ä»¶çš„æ–‡æ¡£è½¬æ¢ï¼‰
    - name: Install Pandoc ðŸ“„
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc

    # 4. å®‰è£… Hexo CLI å’Œé¡¹ç›®ä¾èµ–
    - name: Install Dependencies ðŸ“¦
      run: |
        npm install -g hexo-cli
        npm install

    # 5. åˆå§‹åŒ–å’ŒéªŒè¯ PublishNote å­æ¨¡å—
    - name: Setup Submodules ðŸ“š
      run: |
        echo "Checking submodule status..."
        git submodule status
        echo "Initializing submodules..."
        git submodule update --init --recursive
        echo "Verifying PublishNote..."
        ls -la PublishNote/
        echo "Found $(find PublishNote -name "*.md" | wc -l) markdown files"

    # 6. åŒæ­¥ PublishNote æ–‡ç« åˆ°ä¸»ç›®å½•
    - name: Sync PublishNote Articles ðŸ“
      run: |
        # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
        mkdir -p source/_posts
        # ä»Ž PublishNote å­æ¨¡å—å¤åˆ¶æ‰€æœ‰ .md æ–‡ä»¶åˆ° _posts
        find PublishNote -name "*.md" -type f -exec cp {} source/_posts/ \;
        echo "âœ… Synced $(find PublishNote -name "*.md" | wc -l) articles from PublishNote"
        echo "ðŸ“„ Total posts in source/_posts: $(ls -1 source/_posts/*.md 2>/dev/null | wc -l)"

    # 7. æ¸…ç†å¹¶ç”Ÿæˆé™æ€ç«™ç‚¹
    - name: Build Hexo Site ðŸ—ï¸
      run: |
        hexo clean
        hexo generate

    # 8. éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
    - name: Deploy to gh-pages Branch ðŸš€
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy Hexo site - ${{ github.event.head_commit.message }}'

    # 9. æž„å»ºæ‘˜è¦ï¼ˆå¯é€‰ï¼‰
    - name: Build Summary ðŸ“Š
      if: success()
      run: |
        echo "### ðŸš€ Hexo Site Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ Site will be available at: https://dupouyer.github.io" >> $GITHUB_STEP_SUMMARY

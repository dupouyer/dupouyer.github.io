name: Build and Deploy Hexo

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ° master åˆ†æ”¯æ—¶è‡ªåŠ¨æž„å»º
on:
  push:
    branches:
      - master
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. æ£€å‡ºä»£ç ï¼ˆåŒ…æ‹¬å­æ¨¡å—ï¼‰
    - name: Checkout ðŸ›Žï¸
      uses: actions/checkout@v4
      with:
        submodules: recursive  # é€’å½’å…‹éš†å­æ¨¡å—ï¼ˆPublishNoteï¼‰
        fetch-depth: 0         # èŽ·å–å®Œæ•´çš„ git åŽ†å²

    # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
    - name: Setup Node.js ðŸ”§
      uses: actions/setup-node@v4
      with:
        node-version: '16'     # ä½¿ç”¨ Node.js 16 LTS (æ›´å¥½çš„åŒ…å…¼å®¹æ€§)
        cache: 'npm'           # ç¼“å­˜ npm ä¾èµ–ä»¥åŠ å¿«æž„å»ºé€Ÿåº¦

    # 3. å®‰è£… Pandocï¼ˆç”¨äºŽæŸäº› Hexo æ’ä»¶çš„æ–‡æ¡£è½¬æ¢ï¼‰
    - name: Install Pandoc ðŸ“„
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc

    # 4. å®‰è£… Hexo CLI å’Œé¡¹ç›®ä¾èµ–
    - name: Install Dependencies ðŸ“¦
      run: |
        npm install -g hexo-cli
        npm install

    # 5. åŒæ­¥ PublishNote æ–‡ç« åˆ°ä¸»ç›®å½•
    - name: Sync PublishNote Articles ðŸ“
      run: |
        # ä»Ž PublishNote å­æ¨¡å—ï¼ˆæ ¹ç›®å½•ï¼‰å¤åˆ¶æ‰€æœ‰ .md æ–‡ä»¶åˆ° _posts
        find PublishNote -name "*.md" -type f -exec cp {} source/_posts/ \;
        echo "âœ… Synced $(find PublishNote -name "*.md" | wc -l) articles from PublishNote"

    # 6. æ¸…ç†å¹¶ç”Ÿæˆé™æ€ç«™ç‚¹
    - name: Build Hexo Site ðŸ—ï¸
      run: |
        hexo clean
        hexo generate

    # 7. éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
    - name: Deploy to gh-pages Branch ðŸš€
      run: |
        # é…ç½® git ç”¨æˆ·ä¿¡æ¯
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'

        # ä¿å­˜å½“å‰åˆ†æ”¯
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

        # åˆå§‹åŒ– gh-pages åˆ†æ”¯ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout --orphan gh-pages

        # æš‚å­˜å½“å‰æ›´æ”¹å¹¶åˆ‡æ¢åˆ° gh-pages åˆ†æ”¯
        git stash push -m "Temp stash before deployment"
        git checkout gh-pages 2>/dev/null || git checkout -b gh-pages

        # æ¸…ç† gh-pages åˆ†æ”¯ä¸­çš„æ—§æ–‡ä»¶ï¼ˆä¿ç•™ .gitï¼‰
        find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

        # å¤åˆ¶ public/ ç›®å½•çš„æ‰€æœ‰å†…å®¹åˆ°å½“å‰ç›®å½•
        cp -r public/* .
        cp -r public/.[!.]* . 2>/dev/null || true

        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add -A

        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "âš ï¸ No changes to deploy"
        else
          # æäº¤æ›´æ”¹
          git commit -m "Deploy Hexo site - ${{ github.event.head_commit.message }}"
          # æŽ¨é€åˆ° gh-pages åˆ†æ”¯
          git push origin gh-pages --force
          echo "âœ… Successfully deployed to gh-pages branch"
        fi

        # åˆ‡æ¢å›žåŽŸåˆ†æ”¯
        git checkout "$CURRENT_BRANCH"

    # 8. æž„å»ºæ‘˜è¦ï¼ˆå¯é€‰ï¼‰
    - name: Build Summary ðŸ“Š
      if: success()
      run: |
        echo "### ðŸš€ Hexo Site Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ Site will be available at: https://dupouyer.github.io" >> $GITHUB_STEP_SUMMARY
